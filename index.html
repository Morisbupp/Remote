<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>远程控制台 — 炮机</title>
  <style>
    :root{
      --bg:#f7f2f5; --card:#ffffff; --accent:#e5a5b5; --accent-dark:#d89aad;
      --muted:#9d8b94; --glass: rgba(229,165,181,0.08);
      font-family: Inter, "Helvetica Neue", Arial, sans-serif; color:#5a4d54;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:linear-gradient(180deg,#f9f4f7 0%, #f5eff3 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; }
    .panel{
      width:1100px; max-width:98vw; background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,245,250,0.9));
      border-radius:16px; padding:22px;
      box-shadow: 0 8px 30px rgba(157,139,148,0.15), inset 0 1px 0 rgba(255,255,255,0.8);
      display:grid; grid-template-columns: 410px 1fr; gap:18px; align-items:start;
    }
    .left,.right{background:var(--card); padding:16px; border-radius:12px; box-shadow:0 2px 12px rgba(229,165,181,0.08)}
    h1{margin:0 0 10px; font-size:18px; letter-spacing:.2px; color:var(--accent-dark); font-weight:600}
    .subtitle{color:var(--muted); font-size:13px; margin-bottom:12px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px; font-weight:500}
    .row{margin-bottom:12px}
    .control{display:flex; gap:8px; align-items:center}
    input[type="range"]{-webkit-appearance:none; height:6px; border-radius:8px; background:linear-gradient(90deg,#e5a5b5,#f0c5d1); width:100%; outline:none}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:linear-gradient(135deg,#e5a5b5,#d89aad); box-shadow:0 2px 8px rgba(229,165,181,0.4); cursor:pointer}
    input[type="range"]::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:linear-gradient(135deg,#e5a5b5,#d89aad); box-shadow:0 2px 8px rgba(229,165,181,0.4); border:none; cursor:pointer}
    select,button,input[type="text"]{border-radius:8px; border:1px solid rgba(229,165,181,0.2); padding:8px 10px; background:var(--glass); color:#5a4d54; font-size:13px}
    button.primary{background:linear-gradient(90deg,#e5a5b5,#f0c5d1); color:#5a4d54; font-weight:600; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow:0 2px 8px rgba(229,165,181,0.25); transition:.2s}
    button.primary:hover{background:linear-gradient(90deg,#d89aad,#e5a5b5); box-shadow:0 4px 12px rgba(229,165,181,0.35); transform:translateY(-1px)}
    button.ghost{background:transparent; border:1px solid rgba(229,165,181,0.3); color:var(--muted); cursor:pointer; padding:8px 10px; border-radius:8px; transition:.2s}
    button.ghost:hover{background:rgba(229,165,181,0.1); border-color:rgba(229,165,181,0.5)}
    .small{font-size:12px; color:var(--muted)}

    .vis{display:grid; grid-template-columns: 260px 1fr; gap:16px; min-height:360px}
    .device{
      width:100%; height:280px; border-radius:20px; background:linear-gradient(180deg,#faf7f9,#f5eff3);
      display:flex; align-items:center; justify-content:center; position:relative; box-shadow:0 8px 20px rgba(229,165,181,0.15);
      border:1px solid rgba(229,165,181,0.2); overflow:hidden;
    }
    .piston{ width:64px; height:160px; border-radius:999px; background:linear-gradient(180deg,#f0c5d1,#e5a5b5);
      position:absolute; transform-origin:center; box-shadow:0 4px 12px rgba(229,165,181,0.3) }
    .shaft{ width:10px; height:220px; background:linear-gradient(180deg,#d4c5cc,#c4b5bc); position:absolute; left:calc(50% - 5px); top:24px; border-radius:6px; box-shadow:inset 0 2px 4px rgba(0,0,0,0.05) }
    /* 柔性外包裹（抽象柔软形态） */
    .sheath{
      position:absolute; inset:20px; pointer-events:none;
      filter: drop-shadow(0 6px 10px rgba(229,165,181,0.25));
    }
    /* 画布样式 */
    .block{background:rgba(255,255,255,0.6); border:1px solid rgba(229,165,181,0.25); border-radius:10px; padding:10px}
    canvas{border:1px solid rgba(229,165,181,0.3); border-radius:10px; background:linear-gradient(180deg,#fff, #fff7fa); width:100%}
    .badge{padding:4px 8px; border-radius:999px; background:rgba(229,165,181,0.12); border:1px solid rgba(229,165,181,0.25); font-size:12px; color:#5a4d54}
    .preset-list,.flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    @media (max-width:1100px){ .panel{grid-template-columns:1fr} .vis{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="panel" role="application" aria-label="远程控制面板">
    <div class="left">
      <h1>远程控制台</h1>
      <div class="subtitle">设备管理 · 模式控制 · 预设</div>

      <div class="row">
        <label>连接</label>
        <div class="control">
          <select id="deviceSelect" aria-label="设备选择">
            <option value="AX-2103">AX-2103 · 局域网</option>
            <option value="AX-2103-BLE">AX-2103 · BLE</option>
          </select>
          <button id="connectBtn" class="ghost">Connect</button>
          <div id="status" class="small" style="margin-left:8px">Ready</div>
        </div>
      </div>

      <div class="row">
        <label>推进模式</label>
        <div class="control">
          <select id="mode" aria-label="推进模式">
            <option value="wave">波形推进</option>
            <option value="pulse">脉冲推进</option>
          </select>
          <div style="flex:1"></div>
          <button id="startBtn" class="primary">开始</button>
          <button id="stopBtn" class="ghost">停止</button>
        </div>
      </div>

      <div class="row">
        <label>速度（Speed） <span id="speedVal" class="small" style="margin-left:8px">50</span></label>
        <input id="speed" type="range" min="1" max="100" value="50" />
      </div>

      <div class="row">
        <label>深度（Depth） <span id="depthVal" class="small" style="margin-left:8px">50</span></label>
        <input id="depth" type="range" min="0" max="100" value="50" />
      </div>

      <div class="row">
        <label>机械强度（Intensity） <span id="intVal" class="small" style="margin-left:8px">50</span></label>
        <input id="intensity" type="range" min="0" max="100" value="50" />
      </div>

      <div class="row block">
        <label>吮吸速率（Suction Rate） <span id="suckRateVal" class="small" style="margin-left:8px">50</span></label>
        <input id="suckRate" type="range" min="1" max="100" value="50" />
        <div class="control" style="margin-top:8px">
          <label class="small">节律</label>
          <select id="suckPattern" aria-label="吮吸节律">
            <option value="continuous">连续</option>
            <option value="pulse">脉冲</option>
          </select>
          <div class="badge">当前等级：<span id="suckLevelText">5</span>/10</div>
          <button id="suckDown" class="ghost">↓ 等级</button>
          <button id="suckUp" class="ghost">↑ 等级</button>
          <!-- 开/关 切换 -->
          <button id="toggleSuck" class="primary">吮吸：关闭</button>
        </div>
      </div>

      <div class="row">
        <label>预设</label>
        <div class="preset-list" id="presetList" aria-live="polite"></div>
      </div>

      <div class="row">
        <label>系统日志</label>
        <div class="log" id="log" style="max-height:140px; overflow:auto; background:rgba(229,165,181,0.05); padding:10px; border-radius:8px; border:1px solid rgba(229,165,181,0.1)"></div>
      </div>
    </div>

    <div class="right">
      <div class="vis" role="region" aria-label="设备与示波">
        <!-- 左侧设备动画 + 柔性外包裹 -->
        <div style="position:relative">
          <div class="device" id="device">
            <div class="shaft" aria-hidden="true"></div>
            <!-- 柔软外包裹（SVG） -->
            <svg class="sheath" id="sheath" viewBox="0 0 200 240" preserveAspectRatio="none" aria-hidden="true">
              <defs>
                <linearGradient id="softGrad" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#ffdfe8" stop-opacity="0.9"/>
                  <stop offset="60%" stop-color="#f6c7d4" stop-opacity="0.85"/>
                  <stop offset="100%" stop-color="#f0b8c8" stop-opacity="0.8"/>
                </linearGradient>
              </defs>
              <!-- 柔软包裹体：通过 JS 动态更新 d，实现“被撑开/回缩” -->
              <path id="sheathPath" fill="url(#softGrad)" stroke="rgba(229,165,181,0.6)" stroke-width="1.2"
                    d="M40,10 C35,40 30,120 30,200 C60,225 140,225 170,200 C170,120 165,40 160,10 Z" />
              <!-- 开口边缘高光 -->
              <ellipse id="sheathMouth" cx="100" cy="120" rx="26" ry="12" fill="rgba(255,255,255,0.25)" stroke="rgba(229,165,181,0.55)" stroke-width="1"/>
            </svg>
            <!-- 入体柱 -->
            <div class="piston" id="piston" style="left:calc(50% - 32px); top:60px; transform: translateY(0px)"></div>
          </div>
          <div class="small" style="margin-top:8px">网络延迟：<span id="latency" style="font-weight:700; color:#e5a5b5">0 ms</span></div>
        </div>

        <!-- 右侧：两路示波与控制（电流/吮吸） -->
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="block">
            <div class="flex" style="justify-content:space-between; margin-bottom:8px">
              <div>
                <div style="font-size:14px; font-weight:600">入体电流（mA）</div>
                <div class="small" id="liveParams">推进：— · 速度：— · 深度：— · 机械强度：—</div>
              </div>
              <div class="badge">当前电流：<span id="currentMA">40</span> mA</div>
            </div>
            <canvas id="pulseCanvas" width="500" height="140"></canvas>
            <div class="flex" style="margin-top:8px; justify-content:flex-end">
              <button id="maDown" class="ghost">↓ 电流</button>
              <button id="maUp" class="ghost">↑ 电流</button>
              <span class="small" style="margin-left:6px">↑/↓ 也可调节</span>
            </div>
          </div>

          <div class="block">
            <div class="flex" style="justify-content:space-between; margin-bottom:8px">
              <div>
                <div style="font-size:14px; font-weight:600">体外吮吸（等级）</div>
                <div class="small">节律：<span id="suckPatternLabel">连续</span> · 速率：<span id="suckRateLabel">—</span></div>
              </div>
              <div class="badge">当前等级：<span id="suckLevelBadge">5</span>/10</div>
            </div>
            <canvas id="suckCanvas" width="500" height="120"></canvas>
          </div>

          <div>
            <div style="font-size:13px; font-weight:600; margin-bottom:6px; color:#5a4d54">快捷预设</div>
            <div class="flex" id="quickChips"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const connectBtn = document.getElementById('connectBtn');
    const status = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const speedEl = document.getElementById('speed');
    const depthEl = document.getElementById('depth');
    const intEl = document.getElementById('intensity');
    const speedVal = document.getElementById('speedVal');
    const depthVal = document.getElementById('depthVal');
    const intVal = document.getElementById('intVal');
    const modeEl = document.getElementById('mode');
    const piston = document.getElementById('piston');
    const logEl = document.getElementById('log');
    const liveParams = document.getElementById('liveParams');
    const latencyEl = document.getElementById('latency');

    // 柔软外包裹元素
    const sheath = document.getElementById('sheath');
    const sheathPath = document.getElementById('sheathPath');
    const sheathMouth = document.getElementById('sheathMouth');

    // 电流画布
    const pulseCanvas = document.getElementById('pulseCanvas');
    const pctx = pulseCanvas.getContext('2d');
    const maUpBtn = document.getElementById('maUp');
    const maDownBtn = document.getElementById('maDown');
    const maText = document.getElementById('currentMA');

    // 吮吸画布与控件（开关）
    const suckCanvas = document.getElementById('suckCanvas');
    const sctx = suckCanvas.getContext('2d');
    const suckRateEl = document.getElementById('suckRate');
    const suckRateVal = document.getElementById('suckRateVal');
    const suckRateLabel = document.getElementById('suckRateLabel');
    const suckPatternEl = document.getElementById('suckPattern');
    const suckPatternLabel = document.getElementById('suckPatternLabel');
    const suckLevelText = document.getElementById('suckLevelText');
    const suckLevelBadge = document.getElementById('suckLevelBadge');
    const suckUpBtn = document.getElementById('suckUp');
    const suckDownBtn = document.getElementById('suckDown');
    const toggleSuckBtn = document.getElementById('toggleSuck');

    // 快捷预设容器
    const presetList = document.getElementById('presetList');
    const quickChips = document.getElementById('quickChips');

    let isConnected=false, isRunning=false, tickHandle=null, startTime=0, latency=0;
    // 入体电流（mA）
    let currentMA = 40; // 0–100 mA
    // 吮吸模块
    let suckLevel = 5;      // 0–10
    let suckOn = false;     // 开关
    const presets = [
      {name:"柔和开启",   mode:"wave",  speed:30, depth:25, intensity:30, currentMA:20, suckRate:30, suckPattern:"continuous", suckLevel:3, suckOn:true},
      {name:"节律脉冲",   mode:"pulse", speed:65, depth:40, intensity:55, currentMA:45, suckRate:50, suckPattern:"pulse",      suckLevel:6, suckOn:true},
      {name:"深度推进",   mode:"wave",  speed:55, depth:80, intensity:70, currentMA:35, suckRate:40, suckPattern:"continuous", suckLevel:5, suckOn:false},
      {name:"快速脉冲",   mode:"pulse", speed:85, depth:50, intensity:80, currentMA:60, suckRate:70, suckPattern:"pulse",      suckLevel:7, suckOn:true},
      {name:"外吸主导",   mode:"wave",  speed:40, depth:30, intensity:40, currentMA:25, suckRate:85, suckPattern:"continuous", suckLevel:9, suckOn:true},
      {name:"低速耐久",   mode:"wave",  speed:20, depth:35, intensity:35, currentMA:15, suckRate:20, suckPattern:"continuous", suckLevel:2, suckOn:false},
    ];

    // —— 基础UI —— //
    function log(msg){ const t=new Date().toLocaleTimeString(); logEl.innerHTML = `<div>[${t}] ${escapeHtml(msg)}</div>`+logEl.innerHTML; }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    connectBtn.addEventListener('click', ()=>{
      if(!isConnected){
        connectBtn.textContent='Connecting…'; status.textContent='Linking';
        latency = Math.floor(Math.random()*400)+50; latencyEl.textContent = latency + ' ms';
        setTimeout(()=>{ isConnected=true; connectBtn.textContent='Disconnect'; status.textContent='Connected'; log('连接已建立 · 往返延迟 '+latency+' ms'); }, latency+300);
      }else{
        isConnected=false; connectBtn.textContent='Connect'; status.textContent='Ready'; latency=0; latencyEl.textContent='0 ms';
        stopRun(); log('连接已断开');
      }
    });

    function updateLiveParams(){
      liveParams.textContent = `推进：${modeEl.value} · 速度：${speedEl.value} · 深度：${depthEl.value} · 机械强度：${intEl.value}`;
    }
    [speedEl,depthEl,intEl,modeEl].forEach(el=> el.addEventListener('input', updateLiveParams));
    updateLiveParams();

    speedEl.addEventListener('input', ()=> speedVal.textContent=speedEl.value);
    depthEl.addEventListener('input', ()=> depthVal.textContent=depthEl.value);
    intEl.addEventListener('input',   ()=> intVal.textContent=intEl.value);

    startBtn.addEventListener('click', ()=>{
      if(!isConnected){ log('无法开始：未连接设备。'); return; }
      if(isRunning) return;
      isRunning=true; startTime=performance.now(); log('任务开始 — 推进: '+modeEl.value);
      tickHandle=requestAnimationFrame(tick);
    });
    stopBtn.addEventListener('click', stopRun);
    function stopRun(){
      if(!isRunning){ log('已停止。'); return; }
      isRunning=false; if(tickHandle) cancelAnimationFrame(tickHandle); tickHandle=null;
      piston.style.transform='translateY(0px)'; drawGrid(pctx,pulseCanvas); drawGrid(sctx,suckCanvas);
      log('任务结束');
    }

    // —— 入体电流（mA） —— //
    function setMA(v){ currentMA = Math.max(0, Math.min(100, Math.round(v))); maText.textContent=currentMA; }
    maUpBtn.addEventListener('click', ()=> setMA(currentMA+5));
    maDownBtn.addEventListener('click', ()=> setMA(currentMA-5));
    setMA(currentMA);
    // 键盘：↑/↓ 调 mA；Space 开始/停止；C 切连接
    window.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowUp'){ e.preventDefault(); setMA(currentMA+1); }
      if(e.key==='ArrowDown'){ e.preventDefault(); setMA(currentMA-1); }
      if(e.key===' '){ e.preventDefault(); if(isRunning) stopRun(); else startBtn.click(); }
      if(e.key.toLowerCase()==='c'){ connectBtn.click(); }
    });

    // —— 吮吸控制：开关 —— //
    function setSuckLevel(v){ suckLevel = Math.max(0, Math.min(10, Math.round(v))); suckLevelText.textContent=suckLevel; suckLevelBadge.textContent=suckLevel; }
    suckUpBtn.addEventListener('click', ()=> setSuckLevel(suckLevel+1));
    suckDownBtn.addEventListener('click', ()=> setSuckLevel(suckLevel-1));
    setSuckLevel(suckLevel);

    function setSuckOn(on){
      suckOn = !!on;
      toggleSuckBtn.textContent = '吮吸：' + (suckOn ? '开启' : '关闭');
      log('吮吸已' + (suckOn ? '开启' : '关闭'));
    }
    toggleSuckBtn.addEventListener('click', ()=> setSuckOn(!suckOn));
    setSuckOn(false);

    suckRateEl.addEventListener('input', ()=>{
      suckRateVal.textContent = suckRateEl.value;
      suckRateLabel.textContent = `${map(+suckRateEl.value,1,100,0.5,8).toFixed(1)} Hz`;
    });
    suckRateEl.dispatchEvent(new Event('input'));

    suckPatternEl.addEventListener('change', ()=>{
      suckPatternLabel.textContent = suckPatternEl.value==='continuous'?'连续':'脉冲';
    });
    suckPatternEl.dispatchEvent(new Event('change'));

    // —— 预设 —— //
    function applyPreset(p){
      modeEl.value=p.mode; speedEl.value=p.speed; depthEl.value=p.depth; intEl.value=p.intensity;
      speedVal.textContent=p.speed; depthVal.textContent=p.depth; intVal.textContent=p.intensity;
      setMA(p.currentMA);
      suckRateEl.value=p.suckRate; suckRateEl.dispatchEvent(new Event('input'));
      suckPatternEl.value=p.suckPattern; suckPatternEl.dispatchEvent(new Event('change'));
      setSuckLevel(p.suckLevel); setSuckOn(p.suckOn);
      updateLiveParams(); log('已应用预设：'+p.name);
    }
    function renderPresetsWhere(container, list){
      container.innerHTML='';
      list.forEach(p=>{
        const b=document.createElement('button'); b.className='ghost'; b.textContent=p.name; b.addEventListener('click',()=>applyPreset(p));
        container.appendChild(b);
      });
    }
    renderPresetsWhere(presetList, presets);
    renderPresetsWhere(quickChips, presets.slice(0,4));

    // —— 示波绘制 —— //
    function drawGrid(ctx, canvas){
      const w=canvas.width, h=canvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle='rgba(229,165,181,0.25)'; ctx.lineWidth=1;
      for(let x=0;x<w;x+=28){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
      for(let y=0;y<h;y+=28){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
      ctx.strokeStyle='rgba(216,154,173,0.8)';
      ctx.beginPath(); ctx.moveTo(0, h*0.75); ctx.lineTo(w, h*0.75); ctx.stroke();
    }
    drawGrid(pctx,pulseCanvas); drawGrid(sctx,suckCanvas);

    function drawPulseStep(){
      const w=pulseCanvas.width, h=pulseCanvas.height;
      // 左移
      const img = pctx.getImageData(2,0,w-2,h); pctx.putImageData(img,0,0);
      pctx.clearRect(w-2,0,2,h);
      pctx.strokeStyle='rgba(229,165,181,0.25)'; pctx.beginPath(); pctx.moveTo(w-2,0); pctx.lineTo(w-2,h); pctx.stroke();
      // 高电平
      const speed=+speedEl.value, hz=map(speed,1,100,0.5,10), duty=0.2;
      const t=(performance.now()/1000)%1, phase=(t*hz)%1;
      const high = isRunning && (phase<duty);
      const amp = currentMA/100; // 0–1
      const baseline=h*0.75, highY = baseline - amp*(h*0.6);
      pctx.strokeStyle='rgba(229,165,181,0.95)'; pctx.lineWidth=2;
      pctx.beginPath(); pctx.moveTo(w-2, high ? highY : baseline); pctx.lineTo(w-2, baseline); pctx.stroke();
    }

    function drawSuckStep(){
      const w=suckCanvas.width, h=suckCanvas.height;
      const img = sctx.getImageData(2,0,w-2,h); sctx.putImageData(img,0,0);
      sctx.clearRect(w-2,0,2,h);
      sctx.strokeStyle='rgba(229,165,181,0.25)'; sctx.beginPath(); sctx.moveTo(w-2,0); sctx.lineTo(w-2,h); sctx.stroke();

      const rate=+suckRateEl.value, hz=map(rate,1,100,0.5,8);
      const t=(performance.now()/1000)%1, phase=(t*hz)%1;
      const pattern = suckPatternEl.value; // continuous | pulse
      let high=false;
      if(pattern==='continuous'){ high = (isRunning && suckOn); }
      else { high = (isRunning && suckOn) && (phase < 0.33); } // 33%占空比
      const amp = suckLevel/10;
      const baseline=h*0.7, highY = baseline - amp*(h*0.55);

      sctx.strokeStyle='rgba(216,154,173,0.95)'; sctx.lineWidth=2;
      sctx.beginPath(); sctx.moveTo(w-2, high ? highY : baseline); sctx.lineTo(w-2, baseline); sctx.stroke();
    }

    // —— 柔软外包裹形变 —— //
    // 目标：随“柱”纵向位置和机械强度一起微调“开口宽度”，表现撑开/回缩
    function updateSheathShape(pistonY){
      // 视口（SVG）大小：200 × 240；开口位于 y=120 附近
      // 基础参数
      const baseMouthRx = 18;           // 基础开口半径X
      const baseMouthRy = 9;            // 基础开口半径Y
      const intensity = +intEl.value/100; // 0–1
      const depth = +depthEl.value/100;   // 0–1

      // 将柱位置（px）映射为 0–1 的推进比：向内推进 -> mouth 扩张
      // pistonY 是 transform: translateY(-smooth) 中的 -smooth，这里取其绝对值
      const prog = Math.min(1, Math.max(0, Math.abs(pistonY)/80)); // 0..1
      // 扩张量：随推进（prog）与机械强度共同作用
      const expand = (prog*0.7 + intensity*0.3) * 22; // 最大额外扩张 ~22px

      const rx = baseMouthRx + expand;
      const ry = baseMouthRy + expand*0.35;

      // 更新开口高光椭圆
      sheathMouth.setAttribute('rx', rx.toFixed(1));
      sheathMouth.setAttribute('ry', ry.toFixed(1));

      // 包裹体轮廓：左右对称的纵向“柔软壁”，中段略鼓。使用可控点根据 rx 调整。
      // 轮廓  Path：从左上->左下->右下->右上闭合
      const topY = 10, botY = 230, midY = 120;
      const leftX0 = 40, rightX0 = 160;

      // 根据口径扩大，整体壁也略外鼓（更柔更开）
      const bulge = Math.min(24, rx*0.35 + ry*0.2);

      // 左侧控制点
      const L1x = leftX0 - Math.min(10, bulge*0.25);
      const L1y = 40;
      const L2x = leftX0 - bulge;
      const L2y = midY;
      const L3x = leftX0 - Math.min(12, bulge*0.3);
      const L3y = 200;

      // 右侧控制点（镜像）
      const R1x = rightX0 + Math.min(10, bulge*0.25);
      const R1y = 40;
      const R2x = rightX0 + bulge;
      const R2y = midY;
      const R3x = rightX0 + Math.min(12, bulge*0.3);
      const R3y = 200;

      const d = [
        `M ${leftX0},${topY}`,
        `C ${L1x},${L1y} ${L2x},${L2y} ${leftX0},${botY}`,
        `C ${80},${botY+18} ${120},${botY+18} ${rightX0},${botY}`,
        `C ${R2x},${R2y} ${R1x},${R1y} ${rightX0},${topY}`,
        `C ${120},${topY-16} ${80},${topY-16} ${leftX0},${topY}`,
        `Z`
      ].join(' ');
      sheathPath.setAttribute('d', d);
    }

    // —— 主循环 —— //
    function tick(now){
      if(!isRunning){ return; }
      latencyEl.textContent = latency + ' ms';

      // 设备推进（无随机）
      const depth=+depthEl.value, intensity=+intEl.value, speed=+speedEl.value;
      const elapsed=(now - startTime)/1000, basePx=map(depth,0,100,0,80);
      let pos=0;
      if(modeEl.value==='wave'){
        const freq=map(speed,1,100,0.4,3.5); pos=Math.sin(elapsed*freq*Math.PI*2)*basePx*(intensity/100);
      }else{ // pulse
        const rate=map(speed,1,100,0.5,10), phase=(elapsed*rate)%1; pos=(phase<0.15)? basePx*(intensity/100):0;
      }

      const cur=parseFloat(piston.dataset._smooth||0), smooth=cur+(pos-cur)*0.18;
      piston.dataset._smooth=smooth;
      // 柱向内推进，我们让 translateY 取反（视觉向上/向下取决于坐标），保持与之前一致
      piston.style.transform=`translateY(${ -smooth }px)`;
      piston.dataset.pos=-smooth;

      // 更新柔软外包裹形变
      updateSheathShape(-smooth);

      // 两路示波
      drawPulseStep(); drawSuckStep();

      tickHandle=requestAnimationFrame(tick);
    }

    // —— 工具 —— //
    function map(v,a,b,c,d){ return c + (d - c) * ((v - a) / (b - a)); }

    // 定时刷新标签
    setInterval(()=>{
      speedVal.textContent=speedEl.value; depthVal.textContent=depthEl.value; intVal.textContent=intEl.value; updateLiveParams();
      if(isRunning){ if(!tickHandle) tickHandle=requestAnimationFrame(tick); }
    },120);

    // 初始栅格
    function initGrids(){ drawGrid(pctx,pulseCanvas); drawGrid(sctx,suckCanvas); }
    function drawGrid(ctx,canvas){
      const w=canvas.width, h=canvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle='rgba(229,165,181,0.25)'; ctx.lineWidth=1;
      for(let x=0;x<w;x+=28){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
      for(let y=0;y<h;y+=28){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
      ctx.strokeStyle='rgba(216,154,173,0.8)'; ctx.beginPath(); ctx.moveTo(0, h*0.75); ctx.lineTo(w, h*0.75); ctx.stroke();
    }
    initGrids();

    // 初始日志
    log('系统启动完成');
  })();
  </script>
</body>
</html>
